<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Give Review</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/public/css/bootstrap.min.css">
    <script src="/public/js/bootstrap.bundle.min.js"></script>
    <link rel="icon" type="image/x-icon" href="/public/img/logo-w.png">

    <style>
        .flex {
            display: flex;
            flex-direction: row;
        }

        .bi-star,
        .bi-star-fill {
            transition: color 0.2s ease-in-out;
        }

        .center {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .col {
            display: flex;
            flex-direction: column;
        }

        .hidden {
            display: none;
        }
    </style>

</head>

<body style="background-color: white;">
    <div style="background-color:#FEF3D0;" class="d-flex">
        <div class="d-flex align-items-center"
            style="background:#D46F95; border-radius: 0px 300px 300px 0px; width:auto; max-width: 870px; height: 80px; padding: 13px;">
            <img src="/public/img/logo-w.png" width="66px" alt="Logo">
            <div class="d-flex justify-content-between" style="margin-left: 43px;">
                <a href="/homepage" style="color:white; text-decoration:none; font-size: 15px; padding-left: 43px;">
                    <i class="bi bi-house-door"></i> Homepage
                </a>
                <a href="/cf-status" style="color:white; text-decoration:none; font-size: 15px; padding-left: 45px;">
                    <i class="bi bi-check2-square"></i> สถานะการสั่งซื้อ
                </a>
                <a style="color: white; text-decoration:none; font-size: 15px; padding-left: 43px; padding-right: 110px; "
                    data-bs-toggle="modal" data-bs-target="#helpModal">
                    <i class="bi bi-chat-dots"></i> Help
                </a>
            </div>
            <!-- pop up contect store -->
            <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content" style="background-color: #F3F3E3;">
                        <div class="modal-header" style="background-color:#D46F95;">
                            <h5 class="modal-title" id="helpModalLabel" style="font-weight: 600; color: white;">
                                ช่องทางการติดต่อ</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p style="font-size: 14px;"><i class="bi bi-line"
                                    style="font-size: 20px; color: #06c755"></i><strong>
                                    Line
                                    :</strong> surety_offical</p>
                            <p style="font-size: 14px;"><i class="bi bi-instagram" style="font-size: 20px; background: -webkit-linear-gradient(#f9ce34,#ee2a7b,#6228d7);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;"></i><strong> Instagram :</strong> surety_sp</p>
                            <p style="font-size: 14px;"><i class="bi bi-facebook"
                                    style="font-size: 20px; color: 	#1877F2"></i><strong> Facebook
                                    :</strong> Surety</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex align-items-center ms-auto" style="padding-right: 13px;">
            <button id="btnlogout" style="background: #B72323; border-radius: 13px; border-color: transparent; width: 100px;
                height: 35px; color: white; font-size: 12px; font-weight: 500;" onclick="location.replace('/login');">
                Log out
                <i class="bi bi-box-arrow-right" style="padding-left: 10px;"></i>
            </button>
        </div>
    </div>
    <center>
        <div class="shProduct"></div>

        <div class="shadow m-4" style="background-color: white; width: 670px; border-radius: 6.7px; padding: 20px;">
            <h1 style="font-weight: bold; font-size: 20px;">ให้คะแนนร้าน</h1>
            <div id="rating-stars">
                <i class="bi bi-star" data-value="1" style="color: gray; font-size: 23.45px; cursor: pointer;"></i>
                <i class="bi bi-star" data-value="2" style="color: gray; font-size: 23.45px; cursor: pointer;"></i>
                <i class="bi bi-star" data-value="3" style="color: gray; font-size: 23.45px; cursor: pointer;"></i>
                <i class="bi bi-star" data-value="4" style="color: gray; font-size: 23.45px; cursor: pointer;"></i>
                <i class="bi bi-star" data-value="5" style="color: gray; font-size: 23.45px; cursor: pointer;"></i>
            </div>
            <div class="flex" style="margin-left: 20px;">
                <span
                    style="font-weight: 600; text-align: start; margin-left: 67px; font-size: 20.1px;">ความคิดเห็น</span>
                <div style="margin-left: 268px;">
                    <!-- Hidden file input -->
                    <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFileSelect()">
                    <button id="upload-button"
                        style="border: none; background-color: #161E52; color: white; width: 80.4px; height: 26.8px; border-radius: 16.75px; font-weight: 500; font-size: 13.4px;"
                        onclick="document.getElementById('file-input').click();">เพิ่มรูปภาพ</button>
                </div>
            </div>
            <textarea id="comment"
                style="background-color: #d9d9d9; width: 469px; height: 100.5px; margin-top: 6.7px; margin-bottom: 6.7px; padding: 10.05px;"></textarea>
            <div class="col center">
                <!-- Image preview -->
                <img id="image-preview" src="/public/img/white.png" alt=""
                    style="max-width: 167.5px; object-fit: contain;">
                <input type="file" hidden>
                <button id="submit-rating"
                    style="border: none; background-color: #BDE3A7; width: 120.6px; height: 40.2px; border-radius: 16.75px; font-weight: bold; font-size: 16.75px; margin-top: 6.7px;">ยืนยัน</button>
            </div>
        </div>

    </center>

</body>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const path = window.location.pathname;
        const orderId = path.split('/').pop(); // Extract orderId from the URL path

        if (!orderId || isNaN(orderId)) {
            showAlert('Order ID is missing or invalid.', 'error');
            console.error('Order ID is missing or invalid.');
            return;
        }


        try {
            // Fetch order details based on orderId
            const response = await fetch(`/reviewProduct/${orderId}`);
            const order = await response.json();

            if (!response.ok) {
                throw new Error(order.error || 'Failed to fetch order details.');
            }

            // Populate product section
            document.querySelector('.shProduct').innerHTML = `
            <div class="flex m-4 shadow"
                style="background-color: #E6F3FF; width: 972px; height: 134px; border-radius: 13px; align-items: center;">
                <img id="productImage" src="/public/img/${order.product_img}" alt="Product Image"
                    style="height: 100px; border-radius: 13px; margin-left: 40px;">
                <div class="column" style="margin-left: 40px;">
                    <h1 id="productName" style="font-weight: bold; text-align: start; font-size: 20px;">${order.product_name}</h1>
                    <div style="text-align: start;">
                        <strong style="font-size: 17px;">ราคา: </strong>
                        <span id="trackingNumber" style="font-size: 17px;">${order.product_price}</span>
                        <br>
                        <strong style="font-size: 17px;">เลขพัสดุ: </strong>
                        <span id="trackingNumber" style="font-size: 17px;">${order.order_tracknum}</span>
                        <br>
                        <strong style="font-size: 17px;">จัดส่งโดย: </strong>
                        <span id="shippingName" style="font-size: 17px;">${order.order_shipname}</span>
                    </div>
                </div>
            </div>

        `;

            handleStarRating(); // Initialize star rating

            // Handle image upload and preview
            const uploadButton = document.getElementById('upload-button');
            const fileInput = document.getElementById('file-input');
            const imagePreview = document.getElementById('image-preview');

            // Show preview when an image is selected
            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result; // Update image preview
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Handle form submission
            document.querySelector('#submit-rating').addEventListener('click', async () => {
                const comment = document.querySelector('#comment').value.trim();
                const selectedRating = getSelectedRating();
                const file = fileInput.files[0]; // Image file

                if (!selectedRating) {
                    showAlert('Please select a star rating.', 'error');
                    return;
                }


                const formData = new FormData();
                formData.append('orderId', orderId);
                formData.append('score', selectedRating);
                formData.append('comment', comment);
                if (file) {
                    formData.append('reviewImg', file); // Append file to FormData
                }

                try {
                    const response = await fetch('/submitReview', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (result.success) {
                        showAlert('Review submitted successfully!', 'success');
                        location.href = `/cf-status`;
                    } else {
                        throw new Error(result.error || 'Failed to submit review.');
                    }

                } catch (error) {
                    console.error('Error submitting review:', error);
                    showAlert('Failed to submit review. Please try again.');
                }
            });

        } catch (error) {
            console.error('Error fetching order details:', error);
            showAlert('Failed to load order details.');
        }
    });

    let selectedRating = 0; // Variable to store the selected rating

    // Function to get the selected rating
    function getSelectedRating() {
        return selectedRating;
    }

    // Handle star rating functionality
    function handleStarRating() {
        const stars = document.querySelectorAll('#rating-stars .bi-star, #rating-stars .bi-star-fill');

        function updateStars(rating) {
            stars.forEach(star => {
                const value = parseInt(star.dataset.value, 10);
                star.classList.toggle('bi-star-fill', value <= rating);
                star.classList.toggle('bi-star', value > rating);
                star.style.color = value <= rating ? 'darkorange' : 'gray';
            });
        }

        stars.forEach(star => {
            star.addEventListener('mouseover', () => updateStars(parseInt(star.dataset.value, 10)));
            star.addEventListener('mouseout', () => updateStars(getSelectedRating()));
            star.addEventListener('click', () => {
                selectedRating = parseInt(star.dataset.value, 10); // Persistently store selected rating
                updateStars(selectedRating);
            });
        });
    }
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.textContent = message;
        alertDiv.style.cssText = `
        position: fixed; 
        top: 20px; 
        right: 20px; 
        padding: 15px; 
        border-radius: 8px; 
        background-color: ${type === 'success' ? '#BDE3A7' : '#FFB3B3'};
        color: ${type === 'success' ? '#2E7D32' : '#D32F2F'};
        font-weight: bold;
        z-index: 1000;
    `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }


</script>

</html>